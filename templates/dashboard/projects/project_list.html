{% extends base_template %}
{% load i18n %}
{% load projects_filters %}


{% block meta %}
<meta name="description" content="Access popular ready projects, control panels, and apps. One-click installation, ready in minutes.">
<meta name="keywords" content="ready projects, install apps, control panels, projects store, one click install">
<meta name="robots" content="index, follow">

<!-- Open Graph for social sharing -->
<meta property="og:title" content="Ready Projects Store">
<meta property="og:description" content="Access popular ready projects, control panels, and apps. One-click installation, ready in minutes.">
<meta property="og:url" content="{{ request.build_absolute_uri }}">
<meta property="og:type" content="website">
<!-- CSS -->
<link rel="stylesheet" href="https://unpkg.com/sal.js/dist/sal.css">
{% endblock meta %}


{% block sheri %}
{% if base_template == 'base.html' %}
<style>
/* خلفية متدرجة تتحرك يمين/يسار */
.header-animated {
    position: relative;
    background: linear-gradient(43deg, #fecd3a 30%, #ffffff 31%, #2b2b2b 30%, #2b2b2b 50%, #ffffff 51%, #0d6efd 50%);
    background-size: 200% 200%;
    animation: gradientMove 10s ease-in-out infinite alternate;
    overflow: hidden;
}

/* حركة التدرج */
@keyframes gradientMove {
    0% {
        background-position: left top;
    }
    100% {
        background-position: right bottom;
    }
}

/* طبقة تغبيش خفيف */
.header-animated::before {
    content: "";
    position: absolute;
    inset: 0;
    backdrop-filter: blur(20px); /* تغبيش */
    background-color: rgba(0, 0, 0, 0.2); /* طبقة شفافة */
    z-index: 0;
}

.header-animated > * {
    position: relative;
    z-index: 1; /* عشان النص فوق الطبقة */
}

</style>
<!-- header -->
<div class="px-4 py-5 text-center text-white header-animated" data-sal="fade" data-sal-delay="100" data-sal-duration="800">
    <div class="py-5"></div>
    <h1 class="display-5 fw-bold mb-4">{% trans "Ready Projects Store" %}</h1>
    <div class="col-lg-7 mx-auto">
        <p class="fs-5 mb-4" data-sal="fade" data-sal-delay="300" data-sal-duration="800">
            {% trans "Access popular ready projects, control panels, and apps. Get up and running in minutes with smooth one-click installation." %}
        </p>
        <a href="{% url 'Signup' %}" class="btn btn-light btn-lg shadow">
            <i class="bi bi-cart-plus"></i> 
            <span data-sal="fade" data-sal-delay="400" data-sal-duration="800">{% trans "Subscribe Now" %}</span>
        </a>
    </div>
</div>
<!-- end header -->

{% endif %}
<div class="py-5 px-4" data-sal="fade" data-sal-delay="300" data-sal-duration="800">
    <div class="row">
    <!-- LEFT: FILTERS -->
    <div class="col-md-3">
      <div class="bg-white p-3 shadow-sm rounded-3 mb-5">
        <form method="get" class="d-flex flex-column gap-3">
          <!-- Search -->
          <div class="position-relative">
            <div class="input-group">
              <span class="input-group-text bg-primary text-white">
                <i class="fa-solid fa-magnifying-glass"></i>
              </span>
              <input type="text" name="search" id="projectSearch" class="form-control"
                     placeholder="{% trans 'Search projects...' %}" autocomplete="off" aria-expanded="false" role="combobox">
              <div id="projectResults" class="list-group position-absolute w-100"
                   style="z-index:1000;display:none;top:35px;"></div>
            </div>
          </div>
          {{ form.media }}

          <!-- Categories -->
          <div class="input-group">
            <span class="input-group-text bg-dark text-white">
              <i class="fa-solid fa-layer-group"></i>
            </span>
            <div class="form-control">{{ form.categories }}</div>
          </div>

          <!-- Technologies -->
          <div class="input-group">
            <span class="input-group-text bg-secondary text-white">
              <i class="fa-solid fa-code"></i>
            </span>
            <div class="form-control">{{ form.technologys }}</div>
          </div>

          <!-- Difficulty -->
          <div class="input-group">
            <span class="input-group-text bg-info text-white">
              <i class="fa-solid fa-signal"></i>
            </span>
            <select class="form-select" name="difficulty">
              <option value="">{% trans "Any difficulty" %}</option>
              <option value="beginner">{% trans "Beginner" %}</option>
              <option value="intermediate">{% trans "Intermediate" %}</option>
              <option value="advanced">{% trans "Advanced" %}</option>
            </select>
          </div>

          <!-- Order -->
          <div class="input-group">
            <span class="input-group-text bg-success text-white">
              <i class="fa-solid fa-arrow-down-wide-short"></i>
            </span>
            <select class="form-select" name="order">
              <option value="">{% trans "Sort by" %}</option>
              <option value="installs">{% trans "Most Installed" %}</option>
              <option value="rating">{% trans "Highest Rated" %}</option>
              <option value="latest">{% trans "Latest" %}</option>
            </select>
          </div>

          <button type="submit" class="btn btn-primary mt-2 w-100">
            <i class="fa-solid fa-search me-1"></i> {% trans "Search" %}
          </button>
        </form>
      </div>
    </div>
    
    <!-- RIGHT: PROJECTS LIST -->
    <div class="col-md-9 container">
      <!-- Featured Projects -->
      <h2 class="fw-bold mb-4 text-warning fs-5">
        <i class="fa-solid fa-star me-1"></i> {% trans "Featured Projects" %}
      </h2>
      <div id="featuredCarousel" class="carousel slide mb-5" data-bs-ride="carousel">
        <div class="carousel-inner">
          {% for project in featured_projects %}
          <div class="carousel-item {% if forloop.first %}active{% endif %}">
            <div class="card shadow border-0 rounded-4 overflow-hidden text-center">
              <img src="{{ project.image.url }}" class="d-block w-100"
                   style="height:300px;object-fit:cover;" loading="lazy" alt="{{ project.name }}">
              <div class="card-body">
                <h5 class="fw-bold">{{ project.name }}</h5>
                <p class="text-muted small">{{ project.description|truncatewords:20 }}</p>
                <span class="badge bg-warning text-dark">⭐ {% trans "Recommended" %}</span>
              </div>
            </div>
          </div>
          {% endfor %}
        </div>
        <button class="carousel-control-prev" type="button" data-bs-target="#featuredCarousel" data-bs-slide="prev">
          <span class="carousel-control-prev-icon"></span>
        </button>
        <button class="carousel-control-next" type="button" data-bs-target="#featuredCarousel" data-bs-slide="next">
          <span class="carousel-control-next-icon"></span>
        </button>
      </div>

      <!-- All Projects -->
      <h2 class="fw-bold mb-4 text-primary fs-5">
        <i class="fa-solid fa-grip-vertical"></i> {% trans "All Projects" %}
      </h2>
      <div class="row row-cols-1 row-cols-md-3 g-4">
        {% for project in projects %}
        <div class="col">
          <div class="card h-100 shadow-sm border-1 rounded-4 overflow-hidden project-card position-relative">
            <!-- IMAGE -->
            {% if project.image %}
            <img src="{{ project.image.url }}" class="card-img-top"
                 style="height:200px;object-fit:cover;" loading="lazy" alt="{{ project.name }}">
            {% else %}
            <div class="bg-light d-flex align-items-center justify-content-center rounded" style="height:200px;">
              <span class="text-muted">{% trans "No Image" %}</span>
            </div>
            {% endif %}

            <!-- BADGES -->
            <div class="position-absolute top-0 start-0 m-2">
              {% if project.is_popular %}
              <span class="badge bg-danger shadow-sm">
                <i class="fa-solid fa-fire me-1"></i> {% trans "Most Popular" %}
              </span>
              {% endif %}
              {% if project.is_new %}
              <span class="badge bg-primary shadow-sm">
                <i class="fa-solid fa-star me-1"></i> {% trans "New" %}
              </span>
              {% endif %}
              {% if project.install_time_minutes <= 5 %}
              <span class="badge bg-warning shadow-sm">
                <i class="fa-solid fa-bolt me-1"></i> {% trans "Fast Install" %}
              </span>
              {% endif %}
              {% if project.is_open_source %}
              <span class="badge bg-success shadow-sm">
                <i class="fa-solid fa-code me-1"></i> {% trans "Open Source" %}
              </span>
              {% endif %}
            </div>

            <!-- CONTENT -->
            <div class="card-body d-flex flex-column p-4">
              <h5 class="card-title fw-bold d-flex justify-content-between align-items-center">
                <span>{{ project.name }}</span>
                <small class="text-muted" title="{% trans 'Total Installs' %}">
                  <i class="fa-solid fa-download me-1"></i> {{ project.get_installs_and_downloads }}
                </small>
              </h5>

              <!-- STAR RATING -->
              <div class="mb-2">
                {% for star in project.rating_stars %}
                  {% if star == "full" %}
                    <i class="fa-solid fa-star text-warning"></i>
                  {% elif star == "half" %}
                    <i class="fa-solid fa-star-half-stroke text-warning"></i>
                  {% else %}
                    <i class="fa-regular fa-star text-warning"></i>
                  {% endif %}
                {% endfor %}
                <small class="text-muted" title="{% trans 'Average Rating' %}">({{ project.average_rating_float|default:"0 / 5" }})</small>
              </div>

              <p class="card-text text-muted small">{{ project.description|truncatewords:20 }}</p>

              <!-- TECHNOLOGIES -->
              <div class="mb-3">
                {% for container in project.containers.all %}
                
                <span class="badge bg-primary me-1">{{ container.get_language_display }}</span>
                {% endfor %}
              </div>

              <!-- BUTTONS -->
            <div class="mt-auto d-flex flex-column gap-2">
                <a href="{% url 'plans_list' project.id %}" class="btn btn-success w-100">
                <i class="fa-solid fa-cloud-arrow-down me-1"></i> {% trans "Install Project" %}
                </a>
                <button class="btn btn-outline-secondary w-100" data-bs-toggle="modal"
                data-bs-target="#projectModal{{ project.id }}">
                <i class="fa-solid fa-file-lines me-1"></i> {% trans "Details" %}
                </button>
                {% if project.docs %}
                <a href="{% url 'view_service_resources' project.id %}" class="btn btn-outline-primary w-100 compare-btn">
                <i class="fa-solid fa-book me-1"></i> {% trans "Documentations" %}
                </a>
                {% endif %}
            </div>
            </div>
          </div>
        </div>

        <!-- Modal -->
        <div class="modal fade" id="projectModal{{ project.id }}" tabindex="-1"
          aria-labelledby="projectModalLabel{{ project.id }}" aria-hidden="true">
          <div class="modal-dialog modal-xl modal-dialog-centered">
            <div class="modal-content rounded-3 shadow-lg">
              <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="projectModalLabel{{ project.id }}">
                  <i class="fa-solid fa-box me-2"></i> {{ project.name }}
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"
                  aria-label="{% trans 'Close' %}"></button>
              </div>
              <div class="modal-body" id="projectModalBody{{ project.id }}">
                <div class="text-center text-muted py-5">
                  <div class="spinner-border text-primary" role="status"></div>
                  <p class="mt-3">{% trans "Loading details..." %}</p>
                </div>
              </div>
            </div>
          </div>
        </div>
        {% endfor %}
      </div>
    </div>
  </div>
</div>



<script src="https://unpkg.com/sal.js/dist/sal.js"></script>


<!-- تحسينات CSS -->
<style>
.text-gradient {
    background: linear-gradient(90deg, #007bff, #6610f2);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
}
.project-card {
    transition: transform 0.3s ease, box-shadow 0.3s ease;
}
.project-card:hover {
    transform: translateY(-6px);
    box-shadow: 0 10px 25px rgba(0,0,0,0.15);
}
.select2-selection {
    border:none !important;
}
</style>
<!--JavaScript لجلب التفاصيل عبر AJAX -->
<script>
document.addEventListener("DOMContentLoaded", function() {
    document.querySelectorAll('[data-bs-target^="#projectModal"]').forEach(button => {
        button.addEventListener("click", function() {
            const projectId = this.getAttribute("data-bs-target").replace("#projectModal", "");
            const modalBody = document.getElementById("projectModalBody" + projectId);

            // عرض تحميل مؤقت
            modalBody.innerHTML = `
                <div class="text-center text-muted py-5">
                    <div class="spinner-border text-primary" role="status"></div>
                    <p class="mt-3">جاري تحميل التفاصيل...</p>
                </div>
            `;

            // طلب AJAX
            fetch(`/projects/${projectId}/details/api/`)
                .then(response => {
                    if (!response.ok) throw new Error("Network response was not ok");
                    return response.text();
                })
                .then(html => {
                    modalBody.innerHTML = html;
                    activateReviewForm();
                })
                .catch(error => {
                    modalBody.innerHTML = `
                        <div class="alert alert-danger text-center">
                            حدث خطأ أثناء تحميل التفاصيل.
                        </div>
                    `;
                    console.error("Fetch error:", error);
                });
        });
    });
});
</script>


<!-- JavaScript لإرسال AJAX وتحديث الواجهة -->
<script>
function activateReviewForm() {
    const stars = document.querySelectorAll("#starRating i");
    const ratingValue = document.getElementById("ratingValue");
    const form = document.getElementById("reviewForm");
    const reviewsList = document.getElementById("reviewsList");

    if (!form || !stars.length || !ratingValue || !reviewsList) return;

    // اختيار النجوم
    stars.forEach(star => {
        star.addEventListener("click", function() {
            const value = parseInt(this.dataset.value);
            ratingValue.value = value;

            stars.forEach(s => {
                if (parseInt(s.dataset.value) <= value) {
                    s.classList.remove("fa-regular", "fa-star");
                    s.classList.add("fa-solid", "fa-star");
                } else {
                    s.classList.remove("fa-solid", "fa-star");
                    s.classList.add("fa-regular", "fa-star");
                }

            });
        });
    });

    // إرسال النموذج عبر AJAX
    form.addEventListener("submit", function(e) {
        e.preventDefault();
        const formData = new FormData(form);

        fetch(form.action, {
            method: "POST",
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if(data.success){
                const r = data.review;
                const li = document.createElement("li");
                li.className = "list-group-item";
                li.innerHTML = `
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <strong class="text-primary">${r.user}</strong>
                            <p class="mb-1 text-muted small">${r.comment}</p>
                        </div>
                        <div class="text-warning">
                            ${'★'.repeat(r.rating)}${'☆'.repeat(5 - r.rating)}
                        </div>
                    </div>
                `;
                reviewsList.prepend(li);
                form.reset();
                ratingValue.value = 0;
                stars.forEach(s => {
                    s.classList.remove("fa-solid", "fa-star");
                    s.classList.add("fa-regular", "fa-star");

                });
            } else {
                showToast(randomGen(), 'نظام', `${data.error}`, '');
            }
        })
        .catch(err => console.error(err));
    });
}

</script>





<!-- search bar auto complite -->
<script>
$(document).ready(function(){
    const $input = $("#projectSearch");
    const $results = $("#projectResults");

    $input.on("input", function() {
        const query = $(this).val();
        if(query.length < 1){
            $results.hide();
            return;
        }

        $.ajax({
            url: "{% url 'project-autocomplete' %}",
            data: { q: query },
            success: function(data){
                $results.empty();
                if(data.length === 0){
                    $results.hide();
                    return;
                }

                data.forEach(function(project){
                    $results.append(`
                        <a href="${project.url}" class="list-group-item list-group-item-action project-item">
                            <img src="${project.image}" width="70">
                            ${project.name}
                        </a>
                    `);
                });
                $results.show();
            }
        });
    });



    // إخفاء القائمة إذا ضغط المستخدم خارجها
    $(document).click(function(e) {
        if(!$(e.target).closest("#projectSearch, #projectResults").length){
            $results.hide();
        }
    });
});

  document.addEventListener('DOMContentLoaded', function() {
      sal({
          threshold: 0.2,   // يبدأ الحركة لما يظهر 20% من العنصر
          once: true        // الحركة مرة وحدة فقط (إذا خليتها false يكرر مع كل scroll)
      });
  });
</script>


{% endblock sheri %}
{% extends "dashboard_base.html" %}
{% load i18n %}

{% block sheri %}
<div class="bg-light p-3 mb-3 rounded">
    <a href="{% url 'project_list' %}" class="btn btn-outline-primary">{% trans "Buy Service" %}</a>
</div>

<div class="container py-4">
    <h5 class="mb-4">{% trans "My Services" %}</h5>
    
    <div class="card shadow-sm p-3">
        <div class="table-responsive">
            <table class="table table-striped table-hover align-middle text-center">
                <thead class="table-light">
                    <tr>
                        <th scope="col">#</th>
                        <th scope="col">{% trans "Project" %}</th>
                        <th scope="col">{% trans "Plan" %}</th>
                        <th scope="col">{% trans "Domain" %}</th>
                        <th scope="col">{% trans "Status" %}</th>
                        <th scope="col">{% trans "Progress" %}</th>
                        <th scope="col">{% trans "Options" %}</th>
                    </tr>
                </thead>
                <tbody>
                    {% for user_service in deployments %}
                    <tr>
                        <th scope="row">{{ forloop.counter }}</th>
                        <td>{{ user_service.project }}</td>
                        <td>{{ user_service.plan }}</td>
                        <td>
                            {% if user_service.domain %}
                                <a href="http://{{ user_service.domain }}" target="_blank">{{ user_service.domain }}</a>
                            {% else %}
                                <span class="text-muted">N/A</span>
                            {% endif %}
                        </td>
                        <td>
                            {% if user_service.status == "Runing" %}
                                <span class="badge bg-success">{{ user_service.get_status_display }}</span>
                            {% elif user_service.status == "Stoped" %}
                                <span class="badge bg-danger">{{ user_service.get_status_display }}</span>
                            {% else %}
                                <span class="badge bg-secondary">{{ user_service.get_status_display }}</span>
                            {% endif %}
                        </td>
                        <td>
                            {% if user_service.get_progress_display == "Create Project" %}
                                <span class="badge bg-primary">{{ user_service.get_progress_display }}</span>
                            {% elif user_service.get_progress_display == "Billing" %}
                                <span class="badge bg-warning text-dark">{{ user_service.get_progress_display }}</span>
                            {% elif user_service.get_progress_display == "Deploying" %}
                                <span class="badge bg-info text-dark">{{ user_service.get_progress_display }}</span>
                            {% elif user_service.get_progress_display == "Complited" %}
                                <span class="badge bg-success">{{ user_service.get_progress_display }}</span>
                            {% elif user_service.get_progress_display == "Failed" %}
                                <span class="badge bg-danger">{{ user_service.get_progress_display }}</span>
                            {% else %}
                                <span class="badge bg-secondary">{{ user_service.get_progress_display }}</span>
                            {% endif %}
                        </td>
                        <td class="d-flex flex-column flex-md-row gap-1">
                            <a href="{% url 'deployment_detail' user_service.id %}" 
                               class="btn btn-outline-primary btn-sm w-100 w-md-auto" 
                               data-bs-toggle="tooltip" title="{% trans 'View Deployment Details' %}">
                               {% trans "View" %}
                            </a>
                            {% if user_service.progress != 4 %}
                            <a href="{% url 'rebuild_project' user_service.id %}" 
                               class="btn btn-outline-primary btn-sm w-100 w-md-auto" 
                               data-bs-toggle="tooltip" title="{% trans 'Restart Device' %}">
                               {% trans "Rebuild" %}
                            </a>
                            {% endif %}
                            <a class="btn btn-outline-danger btn-sm w-100 w-md-auto" 
                               data-bs-toggle="modal" 
                               onclick="deleteItem('{% url 'delete_deployment' user_service.id %}', '{{ user_service.project }}')" 
                               data-bs-target="#exampleModal" 
                               data-bs-toggle="tooltip" title="{% trans 'Delete this Deployment' %}">
                               {% trans "Delete" %}
                            </a>
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="7" class="text-center text-muted">{% trans "No services found." %}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Delete Modal -->
<div class="modal fade" id="exampleModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content rounded-3 shadow">
      <div class="modal-body p-4 text-center">
        <i class="fa-solid fa-triangle-exclamation fa-2x text-danger mb-2"></i>
        <h5 class="mb-2" id="modalProjectName">{% trans "Delete this service?" %}</h5>
        <p class="mb-0">{% trans "After deleting this service you can't restore it again." %}</p>
      </div>
      <div class="modal-footer flex-nowrap p-0">
        <a type="button" id="yesDelete" class="btn btn-lg btn-link fs-6 text-decoration-none col-6 py-3 m-0 rounded-0 border-end">
            <strong>{% trans "Yes, delete" %}</strong>
        </a>
        <button type="button" class="btn btn-lg btn-link fs-6 text-decoration-none col-6 py-3 m-0 rounded-0" data-bs-dismiss="modal">
            {% trans "No thanks" %}
        </button>
      </div>
    </div>
  </div>
</div>

<script>
  function deleteItem(url, projectName){
    document.querySelector('#yesDelete').href = url;
    document.querySelector('#modalProjectName').innerText = `Delete ${projectName}?`;
  }
  // Enable tooltips
  var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'))
  var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
      return new bootstrap.Tooltip(tooltipTriggerEl)
  })
</script>
{% endblock sheri %}

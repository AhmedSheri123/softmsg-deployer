{% extends "dashboard_base.html" %}
{% load i18n %}

{% block sheri %}

<div class="bg-light p-3 mb-3 rounded d-flex flex-wrap gap-2">
    <a href="http://{{ deployment.domain }}" target="_blank" class="btn btn-dark my-1">{% trans "Go To Dashboard" %}</a>
    <button data-bs-toggle="modal" data-bs-target="#ChangeDomainModal" class="btn btn-dark my-1">{% trans "Change Domain" %}</button>
    <a href="{% url 'env_settings' deployment.id %}" class="btn btn-dark my-1">{% trans "Settings" %}</a>


    {% for container in deployment.containers.all %}
    
        {% for action in container.project_container.actions.all %}
        <button class="btn btn-dark my-1" data-bs-toggle="modal" data-bs-target="#ActionModal{{ action.id }}">
            {{ action.label }}
        </button>
        {% include "dashboard/projects/actions/run_action_modal.html" with container=container action=action %}
        {% endfor %}
    {% endfor %}
    <a href="{% url 'view_service_resources' deployment.project.id %}" target="_blank" class="btn btn-dark my-1">{% trans "Documentations" %}</a>
</div>


<!-- Resources Info -->
<div class="container p-4">

  <h5>{% trans "Resource Allocation" %}</h5>
  <div class="row row-cols-1 row-cols-md-3 g-3">
    {% for res in resources %}
    <div class="col">
      <div class="card shadow-sm rounded p-3 h-100">
        <div class="d-flex justify-content-between align-items-center mb-2">
          <div class="d-flex align-items-center gap-2">
            <span class="fs-4">{{ res.icon|safe }}</span>
            <h6 class="mb-0">{{ res.name }}</h6>
          </div>
          <small class="text-muted" id="label-{{ res.name }}">{{ res.used }} {{ res.unit }}</small>
        </div>

        <div class="progress mb-2" style="height: 22px;">
          <div id="progress-{{ res.name }}" class="progress-bar {{ res.color }} progress-bar-striped" role="progressbar"
               style="width: {{ res.percent }}%;" aria-valuenow="{{ res.percent }}"
               aria-valuemin="0" aria-valuemax="100">
            <strong>{{ res.percent }}%</strong>
          </div>
        </div>

        <div class="d-flex justify-content-between">
          <small class="text-muted">{{ res.used }} / {{ res.limit }} {{ res.unit }}</small>
          <small class="text-muted">{{ res.percent }}% {% trans "used" %}</small>
        </div>
      </div>
    </div>
    {% endfor %}
  </div>
    <div class="badge  mb-3 d-block mx-auto">
        <button id="hard-restart-btn" class="btn btn-sm btn-warning my-1 process-btn">
            <span class="btn-text">{% trans "Hard Restart" %}</span>
            <span class="spinner-border spinner-border-sm ms-2" role="status" style="display: none;"></span>
        </button>

        <button id="restart-btn" class="btn btn-sm btn-primary my-1 process-btn">
            <span class="btn-text">{% trans "Restart" %}</span>
            <span class="spinner-border spinner-border-sm ms-2" role="status" style="display: none;"></span>
        </button>

        <button id="stopstart-btn" class="btn btn-sm btn-dark my-1 process-btn">
            <span class="btn-text">{% if deployment.status == 2 %}{% trans "Stop" %}{% else %}{% trans "Start" %}{% endif %}</span>
            <span class="spinner-border spinner-border-sm ms-2" role="status" style="display: none;"></span>
        </button>
        <button id="logs-btn" class="btn btn-sm btn-info my-1">{% trans "Logs" %}</button>
        <a class="btn btn-danger btn-sm my-1" data-bs-toggle="modal" data-bs-target="#exampleModal">{% trans "Delete" %}</a>
    </div>

</div>
<!-- End Resources Info -->



<!-- Deployment Info -->
<div class="container p-4">
    <h5>{% trans "Deployment Info" %}</h5>
    <div class="bg-body-tertiary p-4 rounded">
        <div class="row row-cols-1 row-cols-md-2 g-3">

            <div class="col">
                <label class="form-label">
                    <i class="fa-solid fa-user"></i> {% trans "Username" %}
                </label>
                <input type="text" class="form-control" disabled value="{{ deployment.user.username }}">
            </div>

            <div class="col">
                <label class="form-label">
                    <i class="fa-solid fa-box"></i> {% trans "Project Name" %}
                </label>
                <input type="text" class="form-control" disabled value="{{ deployment.project.name }}">
            </div>

            <div class="col">
                <label class="form-label">
                    <i class="fa-solid fa-server"></i> {% trans "Plan" %}
                </label>
                <input type="text" class="form-control" disabled value="{{ deployment.plan.name }}">
            </div>

            <div class="col">
                <label class="form-label">
                    <i class="fa-solid fa-globe"></i> {% trans "Domain" %}
                </label>
                <input type="text" class="form-control" disabled value="{{ deployment.domain|default:"N/A" }}">
            </div>

            <div class="col">
                <label class="form-label">
                    <i class="fa-solid fa-signal"></i> {% trans "Status" %}
                </label>
                <span class="badge 
                    {% if deployment.status == 'Running' %}bg-success
                    {% elif deployment.status == 'Stopped' %}bg-danger
                    {% else %}bg-secondary{% endif %}">
                    {{ deployment.get_status_display }}
                </span>
            </div>

            <div class="col">
                <label class="form-label">
                    <i class="fa-solid fa-bars-progress"></i> {% trans "Progress" %}
                </label>
                <span class="badge 
                    {% if deployment.progress == '1' %}bg-primary
                    {% elif deployment.progress == '2' %}bg-warning text-dark
                    {% elif deployment.progress == '3' %}bg-info text-dark
                    {% elif deployment.progress == '4' %}bg-success
                    {% elif deployment.progress == '5' %}bg-danger
                    {% else %}bg-secondary{% endif %}">
                    {{ deployment.get_progress_display }}
                </span>
            </div>

        </div>
    </div>
</div>
<!-- End Deployment Info -->


<!-- Subscription -->
<div class="container p-4">
    <h5>{% trans "Subscription Info" %}</h5>
    <div class="bg-body-tertiary p-4 rounded">
        <div class="row row-cols-1 row-cols-md-2">

            <div class="mb-3 col">
                <label class="form-label">
                    <i class="fa-solid fa-file-signature"></i>
                    {% trans "Title" %}
                </label>
                <input type="text" class="form-control" disabled value="{{ deployment.subscription.plan }}">
            </div>

            <div class="mb-3 col">
                <label class="form-label">
                    <i class="fa-solid fa-layer-group"></i>
                    {% trans "Plan scope" %}
                </label>
                <input type="text" class="form-control" disabled value="{{ deployment.subscription.get_duration_display }}">
            </div>

            <div class="mb-3 col">
                <label class="form-label">
                    <i class="fa-solid fa-toggle-on"></i>
                    {% trans "Subscription status" %}
                </label>
                <input type="text" class="form-control" disabled value="{% if deployment.subscription_status %}Active{% else %}Expired{% endif %}">
            </div>

            <div class="mb-3 col">
                <label class="form-label">
                    <i class="fa-solid fa-calendar-plus"></i>
                    {% trans "Subscription date" %}
                </label>
                <input type="text" class="form-control" disabled value="{{deployment.subscription.start_date|date:"Y-m-d"}}">
            </div>

            <div class="mb-3 col">
                <label class="form-label">
                    <i class="fa-solid fa-calendar-xmark"></i>
                    {% trans "Subscription end date" %}
                </label>
                <input type="text" class="form-control" disabled value="{{deployment.subscription.end_date|date:"Y-m-d"}}">
            </div>

            <div class="mb-3 col">
                <label class="form-label">
                    <i class="fa-solid fa-gears"></i>
                    {% trans "Actions" %}
                </label>
                <div>
                    <form class="d-inline-block" action="{% url 'create_order' deployment.project.id %}" method="post">
                        {% csrf_token %}
                        <input type="hidden" name="type" value="2">
                        <input type="hidden" name="deployment_id" value="{{deployment.id}}">
                        <input type="hidden" name="plan_id" value="{{ deployment.subscription.plan.id }}">
                        <input type="hidden" name="duration_type" class="duration_type_input" value="{{deployment.subscription.duration}}">
                        <button type="submit" class="btn bg-light-orange">
                            <i class="fa-solid fa-rotate-right"></i> {% trans "Renew plan" %}
                        </button>
                    </form>

                    <a href="{% url 'UpgradePlan' deployment.id %}" class="btn btn-success">
                        <i class="fa-solid fa-arrow-up"></i> {% trans "Upgrade plan" %}
                    </a>
                </div>
            </div>

        </div>
    </div>
</div>
<!-- End Subscription -->



<!-- Change Domain Modal -->
<div class="modal fade" id="ChangeDomainModal" tabindex="-1" aria-labelledby="ChangeDomainModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content rounded-4 shadow">
            <div class="modal-header p-5 pb-4 border-bottom-0">
                <h1 class="fw-bold mb-0 fs-2">{% trans "Change Project Domain" %}</h1>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body p-5 pt-0">
                <form method="post" action="{% url 'change_project_domain' deployment.id %}">
                    {% csrf_token %}
                    <div class="form-floating mb-3">
                        <input type="text" dir="ltr" name="new_domain" class="form-control rounded-3" id="floatingDomain" placeholder="{% trans "New Domain" %}" value="{{ deployment.domain }}">
                        <label for="floatingDomain">{% trans "New Domain" %}</label>
                    </div>
                    <button class="w-100 mb-2 btn btn-lg rounded-3 btn-primary" type="submit">{% trans "Update Domain" %}</button>
                    <a class="w-100 mb-2 btn btn-lg rounded-3 btn-warning" href="{% url 'reset_project_domain' deployment.id %}" >{% trans "Rset Domain" %}</a>
                    <small class="text-body-secondary">{% trans "By clicking Update, the project domain will be changed." %}</small>
                </form>
            </div>
        </div>
    </div>
</div>
<!-- End Modal -->


<!-- Delete Modal -->
<div class="modal fade" id="exampleModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered" role="document">
        <div class="modal-content rounded-3 shadow">
        <div class="modal-body p-4 text-center">
            <h5 class="mb-0">{% trans "Delete this service?" %}</h5>
            <p class="mb-0">{% trans "after deleting this service you can't restore again." %}</p>
        </div>
        <div class="modal-footer flex-nowrap p-0">
            <a type="button" href="{% url 'delete_deployment' deployment.id %}" id="yesDelete" class="btn btn-lg btn-link fs-6 text-decoration-none col-6 py-3 m-0 rounded-0 border-end"><strong>{% trans "Yes, delete" %}</strong></a>
            <button type="button" class="btn btn-lg btn-link fs-6 text-decoration-none col-6 py-3 m-0 rounded-0" data-bs-dismiss="modal">{% trans "No thanks" %}</button>
        </div>
        </div>
    </div>
</div>
<!-- end Modal  -->

<script>
function refreshUsage() {
    fetch("{% url 'deployment_usage_api' deployment.id %}")
        .then(response => response.json())
        .then(data => {
            for (const [key, res] of Object.entries(data)) {
                const bar = document.querySelector(`#progress-${key}`);
                const label = document.querySelector(`#label-${key}`);
                if (bar && label) {
                    let percent = Math.min(100, Math.round((res.used / res.limit) * 100));
                    bar.style.width = percent + "%";
                    bar.setAttribute("aria-valuenow", percent);
                    bar.className = `progress-bar ${res.color} progress-bar-striped`;
                    bar.textContent = `${percent}%`;
                    label.textContent = `${res.used} / ${res.limit} ${res.unit}`;
                }
            }
        })
        .catch(err => console.error("Usage fetch error:", err));
}

// تشغيل مباشرة عند تحميل الصفحة
document.addEventListener("DOMContentLoaded", () => {
    refreshUsage();
    setInterval(refreshUsage, 5000);
});



let hardRestartBtn = document.getElementById("hard-restart-btn")
let restartBtn = document.getElementById("restart-btn")
let StopStartBtn = document.getElementById("stopstart-btn")


const processBtn = document.querySelectorAll(".process-btn");

function startSpiner(btn) {
    btn.querySelector(".spinner-border").style.display = "inline-block";
    processBtn.forEach(e => {
        e.disabled = true;  
    })
}
function stopSpiner(btn) {
    btn.querySelector(".spinner-border").style.display = "none";
    processBtn.forEach(e => {
        e.disabled = false;  
    })
}

hardRestartBtn.addEventListener("click", () => {
    startSpiner(hardRestartBtn)
    fetch("{% url 'restart_deployment' deployment.id %}", {method: "POST", headers: {'X-CSRFToken': '{{ csrf_token }}'}})
    .then(res => res.json())
    .then(data => alert(data.message))
    .catch(err => console.error(err)).finally(() => {
        stopSpiner(hardRestartBtn)
    });
});

restartBtn.addEventListener("click", () => {
    startSpiner(restartBtn)
    fetch("{% url 'hard_restart_deployment' deployment.id %}", {method: "POST", headers: {'X-CSRFToken': '{{ csrf_token }}'}})
    .then(res => res.json())
    .then(data => alert(data.message))
    .catch(err => console.error(err)).finally(() => {
        stopSpiner(restartBtn)
    });
});

StopStartBtn.addEventListener("click", () => {
    startSpiner(StopStartBtn)
    fetch("{% url 'stopstart_deployment' deployment.id %}", {method: "POST", headers: {'X-CSRFToken': '{{ csrf_token }}'}})
    .then(res => res.json())
    .then(data => {
        alert(data.message);
        location.reload(StopStartBtn); // لتحديث زر Stop/Start
    })
    .catch(err => console.error(err)).finally(() => {
        stopSpiner()
    });
});

document.getElementById("logs-btn").addEventListener("click", () => {
    fetch("{% url 'deployment_logs' deployment.id %}")
    .then(res => res.json())
    .then(data => {
        let logWin = window.open("", "Logs", "width=800,height=600,scrollbars=1");
        data.forEach(item => {
            logWin.document.write("<h3>"+item.container_name+"</h3>");
            if(item.logs) {
                logWin.document.write("<pre>"+item.logs+"</pre>");
            } else {
                logWin.document.write("<pre style='color:red;'>"+item.error+"</pre>");
            }
        });
    })
    .catch(err => console.error(err));
});


</script>

{% endblock sheri %}
